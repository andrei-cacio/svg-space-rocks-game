<!DOCTYPE html>
<html>
<head>
	<title>SVG Fun</title>
</head>
<style>
	rect {
		transition: all 10s ease-in-out;
	}

	circle {
		transition: all 1s ease-in-out;
	}
	#rocket{
		transition: none;
	}
	#stage {
		background-color: #000;
	}

	#score {
		top: 15px;
		position: absolute;
		color: white;
		left: 15px;
	}

	#dev {
		position: absolute;
		top: 15px;
		right: 224px;
		color: green;
	}

	#dev.hide { display: none; }
	#dev.show { display: block; }
</style>
<body>
	<svg id="stage" width="700" height="700" onmousemove="moveRocket(evt)">
	</svg>
	<div id="score"></div>
	<div id="dev" class="show"></div>
	<div></div>

	<script>
		const CANVAS_SIZE = 700;
		const THRESHOLD = 200;
		const TRIGGER_SPEED = 100;
		const RENDER_SPEED = 1000;
		const ROCKET_WIDTH = 20;

		let space = [];
		let bullets = [];
		let rocksCreated = 0;
		let score = 0;
		let rocket;

		const getRandomPos = () => -Math.ceil(Math.random() * THRESHOLD);
		const getRandomSize = () => Math.ceil(Math.random() * 50);
		const getRandomHex = () => Math.round(0xffffff * Math.random()).toString(16);
		const svgns = "http://www.w3.org/2000/svg";
		const stage = document.getElementById('stage');	

		renderRocks(1000);
		infiniteLoop();
		addRocket();
		rocketHit();

		function addRocket(){
			const item = document.createElementNS(svgns, 'circle');
			item.setAttributeNS(null, 'cx', 100);
			item.setAttributeNS(null, 'cy', 600);
			item.setAttributeNS(null, 'r', ROCKET_WIDTH);
			item.setAttributeNS(null, 'fill', 'green');
			item.setAttributeNS(null, 'id', 'rocket');

			stage.appendChild(item);
			rocket = item;
		}

		function moveRocket(e) {
      		const x = e.clientX;
			rocket.setAttributeNS(null, 'cx', x);
  		}

		function rocketHit(){

		}

		function breakRock(rock) {
			const width = parseInt(rock.getAttribute('width'));
			if(width > 10){
				const x = rock.getBoundingClientRect().x;
				const y = rock.getBoundingClientRect().y;

				const newWidth = Math.ceil(width / 2);

				const rock1 = renderItem(newWidth, x - 20, y + 20);
				const rock2 = renderItem(newWidth, x + 20, y - 20);

				run(rock1);
				run(rock2);
			}

			document.getElementById('stage').removeChild(rock);
		}

		const handleShoot = e => {
			if (e.target.tagName === 'rect') return;
			const x = rocket.getBoundingClientRect().x + ROCKET_WIDTH/2;
			const y= rocket.getBoundingClientRect().y - ROCKET_WIDTH/2;
			shoot(attachBullet(x, y));
		}
		document.body.onclick = handleShoot;

		function attachBullet(x, y) {
			const item = document.createElementNS(svgns, 'circle');
			item.setAttributeNS(null, 'cx', x);
			item.setAttributeNS(null, 'cy', y);
			item.setAttributeNS(null, 'r', 5);
			item.setAttributeNS(null, 'fill', 'red');
			
			stage.appendChild(item);

			bullets.push(item);

			return item;
		}

		function cleanSpace() {
			const rocksInStage = [];
			space.forEach(rock => {
				if (rock.getBoundingClientRect().x > CANVAS_SIZE || rock.getBoundingClientRect().y > CANVAS_SIZE) {
					stage.removeChild(rock);
				} else {
					rocksInStage.push(rock);
				}
			});

			space = rocksInStage;
		}


		function cleanBullets() {
			const bulletsInStage = [];
			bullets.forEach(rock => {
				if (rock.getBoundingClientRect().x < -CANVAS_SIZE || rock.getBoundingClientRect().y < -CANVAS_SIZE) {
					stage.removeChild(rock);
				} else {
					bulletsInStage.push(rock);
				}
			});

			bullets = bulletsInStage;
		}

		function renderItem(sizeGiven, xGiven, yGiven) {
			const item = document.createElementNS(svgns, 'rect');
			item.setAttributeNS(null, 'x', xGiven || getRandomPos());
			item.setAttributeNS(null, 'y', yGiven || getRandomPos());

			const size = sizeGiven || getRandomSize();
			item.setAttributeNS(null, 'width', size);
			item.setAttributeNS(null, 'height', size);	
			item.setAttributeNS(null, 'stroke', `#${getRandomHex()}`);
			item.setAttributeNS(null, 'fill', `gray`);

			stage.appendChild(item);

			rocksCreated++;
			space.push(item);

			return item;
		}

		function renderRocks(nr = 0) {
			let idx = 0;
			function _render() {
				if (idx >= nr) return;

				setTimeout(() => {
					const item = renderItem();
					run(item);
					idx++;
					_render();
				}, RENDER_SPEED);
			}

			_render();
		}

		function shoot(bullet) {
			if (!bullet) return;
				
			const x = bullet.getBoundingClientRect().x;	
			const style = `
				transform: translateY(${x - 2000}px);
			`;

			bullet.setAttribute('style', style);
		}

		function run(item) {
			if (!item) return;

			const style = `
				transform: translate(${CANVAS_SIZE + THRESHOLD}px, ${CANVAS_SIZE + THRESHOLD}px);
			`
			setTimeout(() => {
				item
					.setAttribute('style', style);
			}, TRIGGER_SPEED);
		}

		function intersectRect(r1, r2) {
		    var r1 = r1.getBoundingClientRect();    //BOUNDING BOX OF THE FIRST OBJECT
		    var r2 = r2.getBoundingClientRect();    //BOUNDING BOX OF THE SECOND OBJECT
		 
		    //CHECK IF THE TWO BOUNDING BOXES OVERLAP
		  return !(r2.left > r1.right || 
		           r2.right < r1.left || 
		           r2.top > r1.bottom ||
		           r2.bottom < r1.top);
		}

		function checkIfHit() {
			for (rock of space) {
				for (bullet of bullets) {
					if (intersectRect(bullet, rock)) {
						if (!rock.wasHit) {
							score++;
						}
						rock.wasHit = true;
						breakRock(rock);
					}
				}
			}
		}

		function renderScore() {
			document.getElementById('score').innerText = `${score} points`;
		}

		const D_KEY = 68;
		let isDevMode = true;
		function devMode() {
			const rocksCount = `${space.length} rocks`;
			const bulletsCount = `${bullets.length} bullets`;

			document.getElementById('dev').innerText = `${rocksCount} | ${bulletsCount}
			(press D to hide)`;
		}

		document.onkeyup = e => {
			if (e.keyCode === D_KEY) {
				if (isDevMode) {
					isDevMode = false;
					document.getElementById('dev').classList.remove('show');
					document.getElementById('dev').classList.add('hide');
				} else {
					document.getElementById('dev').classList.remove('hide');
					document.getElementById('dev').classList.add('show');
					isDevMode = true;
				}
			}
		};

		function infiniteLoop(){
			setInterval(() => {

				if (isDevMode) {
					devMode();
				}

				cleanSpace();
				cleanBullets();

				renderScore();

				checkIfHit();
			}, 10);
		} 

	</script>
</body>
</html>